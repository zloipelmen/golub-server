services:
  caddy:
    image: caddy:2
    restart: unless-stopped
    ports:
      - "${PUBLIC_PORT:-8443}:443/tcp"
      # Нужно только для Let's Encrypt по домену (можно включить позже)
      - "${PUBLIC_HTTP_PORT:-8080}:80/tcp"
    volumes:
      - ./docker/caddy/Caddyfile:/etc/caddy/Caddyfile:ro
      - ./docker/caddy/certs:/etc/caddy/certs:ro
      - caddy_data:/data
      - caddy_config:/config
    depends_on:
      - server

  server:
    build: .
    restart: unless-stopped
    environment:
      # ВАЖНО: server слушает только ВНУТРИ docker-сети
      HTTP_ADDR: "0.0.0.0:8080"
      # DATABASE_URL оставь как у тебя (пример ниже)
      DATABASE_URL: "postgres://app:app@db:5432/app?sslmode=disable"
    expose:
      - "8080"
    depends_on:
      - db

  db:
    image: postgres:16
    restart: unless-stopped
    environment:
      POSTGRES_DB: app
      POSTGRES_USER: app
      POSTGRES_PASSWORD: app
    volumes:
      - db_data:/var/lib/postgresql/data
    # ВАЖНО: никаких ports наружу

volumes:
  db_data:
  caddy_data:
  caddy_config:

